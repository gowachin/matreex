---
title: '![pkg logo](fig/logo.png){width=2in}'
subtitle: "{matreex} R package"
author: "Maxime Jaunatre"
institute: "UR LESSEM | INRAE" 
date: "2023-02-22 (updated: `r Sys.Date()`)"
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: [default, metropolis, metropolis-fonts]
    nature:
      highlightStyle: github
      highlightLines: true
      highlightSpans: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
library(xaringanExtra)
library(emo)
library(icons)
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(fig.align = "center")
options(cli.progress_show_after = 600) 
```

```{r, eval = FALSE, include = FALSE, echo = FALSE}
# This are the dependencies to compile this rmd.
remotes::install_github("mitchelloharawild/icons")
icons::download_fontawesome()
remotes::install_github("hadley/emo")
```

exclude: true

class: inverse, center, middle

# Introduction

---
exclude: true

# {matreex} R package : forest size distribution simulations

**Résumé :** Le package R {matreex} permet de faire des projections futures des compositions de forêts. A partir de modèles issus d'inventaires forestiers concernant la survie, reproduction et croissance, ce package permet de simuler des placettes avec une composition donnée d'espèces et de suivre la distribution des tailles d'individus. A ces simulations s'ajoutent des modules de coupes régulière et irrégulière ainsi que des perturbations. Le gros avantage de ce package est de passer de fonctions modélisée continues à des matrices de transitions intégrés pour un climat donné. L'utilisation de ces matrices accèlére grandement le calcul et autorise donc des simulations sur plusieurs milliers d'années pour l'étude d'équilibres.



---
exclude: false

```{r xaringan-logo, echo=FALSE}
xaringanExtra::use_logo(
image_url = "fig/logo.png",
width = "55px",
  height = "50px",
)
```

# Objectif : Créer un package

## Partir des codes de Georges et Arnaud

```{r previous_meth, engine='tikz', fig.ext = 'png', engine.opts = list(template = "tex/tikz.tex"), echo = FALSE, eval=TRUE}
\begin{tikzpicture}[
    block/.style={draw,fill=strange,minimum height=2.5em, rounded corners},
    font=\sffamily,>=stealth]
\draw node[block] (nfi) {National Forest Inventory};

\draw node[right= 4cm of nfi, block] (mod) {rec-gr-sv models};
\draw node[below= of mod, block] (cli) {climatic conditions};
\draw node[right= 3cm of mod, block] (ipm) {species IPM};
\draw node[right= 3cm of ipm, block] (sim) {size distribution along time};

\draw[->, thick](nfi) edge node[midway, above](ngf){fitting models} (mod);
\draw[->, thick](nfi) edge (cli);
\draw[->, thick](cli) edge (ipm);
\draw[->, thick](mod) edge node[midway, above](nhf){Integration} (ipm);
\draw[->, thick](ipm) edge node[midway, above]{Simulation} (sim);
\end{tikzpicture}
```

- Code permettant des simulations jusqu'à l'équilibre monospécifique pour un climat donné.

- Code publié avec l'article : *Demographic performance of European tree species at their hot and cold climatic edges* sous la forme d'un pipeline `{targets}`

--

--- 

Deux besoins : 

.pull-left[
Mettre en format package pour faciliter l'utilisation du code
]

.pull-right[
Ajouter des fonctionnalités dans le cadre du projet **FUNPOTENTIAL**
]

---
exclude: false

# Structure 

** Contraintes : **

- Besoin de faire beaucoup de simulations, différents scénariis ou climats.

- Une espèce sous format IPM est relativement lourde et longue à obtenir (2-3min)

** Bonus : **

- Faciliter l'usage pour les utilisateurs avec des fonctions communes


<br>

Choix d'utiliser plusieurs classes **S3**

Les fonctions sont simplifiées et les classes contiennent une structure définie.
Mais tout peut être étendu plus tard par d'autres modules.


---

# Fitted models

```{r show_fit, echo=TRUE, eval = TRUE}
library(matreex) # load pkg
matreex::fit_species[1:3] # list fitted species list
data("fit_Picea_abies") # load a single species model
```

--

```{r show_fit2, echo=TRUE, eval = TRUE}
names(fit_Picea_abies)
fit_Picea_abies$sv
```

---

# IPMs

## Integration

Un IPM est définis pour un climat et un niveau de compétition donné.

```{r, show_ipm, echo = TRUE, eval = TRUE, cache=TRUE}
data("climate_species")
climate <- subset(climate_species, N == 2 & sp == "Picea_abies", select = c(1:6, 9))
climate

Picea_ipm <- make_IPM(
    species = "Picea_abies", 
    climate = climate, 
    fit = fit_Picea_abies,
    clim_lab = "optimum clim", 
    mesh = c(m = 700, L = 90, U = 1095 * 1.1),
    BA = 0:120
)
```

---

# IPMs

## Summary

```{r, sum_ipm, echo = TRUE, eval = TRUE, cache=TRUE}
summary(Picea_ipm)
```

```{r ipms, engine='tikz', fig.ext = 'png', engine.opts = list(template = "tex/tikz.tex"), echo = FALSE, eval=TRUE}


\tikzset{
        kernel/.pic={
        \foreach \i in {5,4.5,...,0.5}{
            {\fill[gray!50] (\i, 5-\i) -- (5,5-\i) -- (5,5) -- (\i,5);}
        }
        \draw (0,0) grid[step=.5] (5,5);
    }
}

\tikzset{
    kernf/.pic={
        \fill[white] (0, 0) -- (5,0) -- (5,5) -- (0,5) -- cycle;
    }
}

\begin{tikzpicture}[scale=0.25, every node/.style={transform shape}, scale line widths]

    \draw (3,-2.25) pic {kernf};
    \draw[opacity = 0.1](3,-2.25) pic {kernel};
    \draw (2,-1.5) pic {kernf};
    \draw[opacity = 0.2](2,-1.5) pic {kernel};
    \draw (1,-0.75) pic {kernf};
    \draw[opacity = 0.3](1,-0.75) pic {kernel};

    \begin{scope}

        \draw (0,0) pic {kernf};
                \foreach \i in {3,2.5,...,0}{
                    {\fill[blue!50] (\i, 5-\i-2) -- (5,5-\i-2) -- (5,5) -- (\i,5);}
            }
        \foreach \i in {4,3.5,...,0}{
                    {\fill[red!50] (\i, 5-\i-1) -- (5,5-\i-1) -- (5,5) -- (\i,5);}
            }
        \foreach \i in {5,4.5,...,0.5}{
                    {\fill[gray!50] (\i, 5-\i) -- (5,5-\i) -- (5,5) -- (\i,5);}
            }
        
        \draw (0,0) grid[step=.5] (5,5);
        \draw (2.5,5) node[above]{$size_t$} ;
        \draw (0,2.5) node[left]{$size_{t+1}$} ;
        \draw(0,5) node[above] {$L$};
        \draw(5,5) node[above] {$U$};
        
        \draw(7,5) node[fill=red!50,above] {Gauss-Legendre};
        \draw(7,5) node[fill=blue!50,below] {Midbin};
        \draw[->] (0, -0.5) -- (2.5,-2.25);
        \draw(1,-1.25) node[below, rotate = -35] {Basal Area};
    \end{scope}

\end{tikzpicture}
```


---

# Species and Forest

## Create a species

```{r create_sp,  echo = TRUE, eval = TRUE}
Picea_sp <- species(IPM = `Picea_ipm`, 
                    init_pop = def_init,
                    harvest_fun = def_harv,
                    disturb_fun = def_disturb,
                    harv_lim = c(dth = 175, dha = 575, hmax = 1),
                    rdi_coef = NULL,
                    disturb_coef = NULL
  )
```

--

## Create a forest

```{r create_for,  echo = TRUE, eval = TRUE}
Picea_for <- forest(species = list(Picea = `Picea_sp`), 
                    harv_rules = c(Pmax = 0.25, dBAmin = 3, 
                                   freq = 1, alpha = 1))
```

---
exclude: false

```{r class, engine='tikz', fig.ext = 'png', engine.opts = list(template = "tex/tikz.tex"), echo = FALSE, eval=TRUE}

\def\r{0.2}

\tikzset{
        kernel/.pic={
        \foreach \i in {5,4.5,...,0.5}{
            {\fill[gray!50] (\i, 5-\i) -- (5,5-\i) -- (5,5) -- (\i,5);}
        }
        \draw (0,0) grid[step=.5] (5,5);
    }
}

\tikzset{
    kernf/.pic={
        \fill[white] (0, 0) -- (5,0) -- (5,5) -- (0,5) -- cycle;
    }
}

\begin{tikzpicture}[scale=0.25, every node/.style={transform shape}]

% \draw (-7,-17) to[grid with coordinates] (15, 1);

\node at (0,0) (forest) {};
\draw [rounded corners, fill = g1!60] (forest) rectangle +(14.2, -16.6) {};
\node [below right=\r cm and \r cm of forest] { \textbf{Forest class} (community/plot)};

\node at (\r, -1.2) (harvr) {};    \node at (2*\r + 9, -1.2) (infoF) {}; 
\draw [rounded corners, dashed] (harvr) rectangle node[text width=12cm, align= center]{
    \textbf{harv\_rules} $[$\scriptsize Pmax, dBAmin, freq, alpha\normalsize $]$ } +(9, -1);

\draw [rounded corners, dotted] (infoF) rectangle node[text width = 4.6cm, align= center]{
    \textbf{info} list \\ \scriptsize Species name and clim\_lab \normalsize } +(4.6, -1);

\begin{scope}[xshift = 2*\r cm, yshift = -2.8 cm]

\node at (-\r, \r) (species) {};
\draw [rounded corners, dotted] (species)rectangle +(13.8, -13.8) {};

\node at (0, 0) (speciesB) {};
% \draw [rounded corners] (speciesB)rectangle +(13.4, -13.2) {};
\draw [rounded corners, fill = g2!60] (speciesB) -- (4,0) -- (4,-1) -- (13.4,-1) -- (13.4, -13.4) -- (0, -13.4) -- cycle;
\node [below right=\r cm and \r cm of speciesB] {\textbf{Species class}};

\node at (4.2, 0) (sp1) {};           \node at (4.2 + 3.2, 0) (sp2) {}; 

\draw [rounded corners, fill = g2!60] (sp1) rectangle node{Species A} +(3, -0.8);
\draw [rounded corners, fill = g2!60] (sp2) rectangle node{Species B} +(3, -0.8);

% layout
\begin{scope}[xshift = \r cm, yshift = -1.2 cm]
\node at (0, 0) (init) {};    \node at (4.2 + \r , 0) (recruit) {};
\node at (0, -\r -1) (harv) {};   \node at (4.2 + \r , -\r - 1) (harvl) {};  \node at (3.4 + 4.2 + 2*\r , -\r - 1) (rdi) {};
\node at (0, -2*\r -2) (dist) {};   \node at (5.6 + \r , -2*\r - 2) (distc) {};


\draw [rounded corners, loosely dashdotted] (init) rectangle node[text width=4.2cm, align= center]{
    \textbf{init\_pop}(\scriptsize mesh, SurfEch\normalsize) } +(4.2, -1);
\draw [rounded corners, loosely dashdotted] (recruit) rectangle node[text width=8.6cm, align= center]{
    \textbf{recruit\_fun}(\scriptsize BATOTSP, BATOTNonSP, mesh, SurfEch\normalsize) } +(8.6, -1);

\draw [rounded corners, loosely dashdotted] (harv) rectangle node[text width=4.2cm, align= center]{
    \textbf{harv\_fun}(\scriptsize x, species, ...\normalsize) } +(4.2, -1);
\draw [rounded corners, dashed] (harvl) rectangle node[text width=3.4cm, align= center]{
    \textbf{harv\_lim} vector } +(3.4, -1);
\draw [rounded corners, dashed] (rdi) rectangle node[text width=3.4cm, align= center]{
    \textbf{rdi\_coef} vector } +(3.4, -1);

\draw [rounded corners, loosely dashdotted] (dist) rectangle node[text width=5.6cm, align= center]{
    \textbf{disturb\_fun}(\scriptsize x, species, disturb, ...\normalsize) } +(5.6, -1);
\draw [rounded corners, dashed] (distc) rectangle node[text width=5.6cm, align= center]{
    \textbf{disturb\_coef} vector } +(5.6, -1);

\end{scope}



\begin{scope}[xshift = \r cm, yshift = -5 cm] % IPM class
\node at (0, 0) (IPM) {};
\draw [rounded corners, fill = g3!60] (IPM) rectangle +(13, -8.2) {};
\node [below right=\r cm and \r cm of IPM] {\textbf{IPM class}, matrices after integration from fitted models};

\begin{scope}[xshift = \r cm, yshift = -1 cm]

\begin{scope}
% IPM matrices scope
\node at (0, 0) (IPM) {};
\draw [rounded corners, dotted] (IPM) rectangle +(6, -3.4);
\node [below right=\r cm and \r cm of IPM] (mlab) {\textbf{Growth * Mortality} matrices};

% layout
\node [below left=1.5 cm and 0cm of mlab] (k1) {};
\node [below right= \r/2 cm and \r cm of k1] (k2) {};
\node [below right= \r/2 cm and \r cm of k2] (k3) {};

\draw pic[scale = 0.3] at(k3) {kernf};
\draw pic[scale = 0.3, opacity = 0.2] at(k3) {kernel};
\draw pic[scale = 0.3] at(k2) {kernf};
\draw pic[scale = 0.3, opacity = 0.3] at(k2) {kernel};
\draw pic[scale = 0.3] at(k1) {kernf};
\draw pic[scale = 0.3, opacity = 0.6] at(k1) {kernel};
\node [above right= -3*\r cm and 2.5 cm of k1, text width=3cm,align=center] {
    Dimensions: \\ $m * m * BA$ \\~\\ Names : $BA$ \tiny\\$m = length(mesh)$};
\end{scope}


\begin{scope}[xshift = 6.2 cm]
% scope for simple vectors
% layout
\node at (0, 0) (BAv) {};           \node at (3.2, 0) (mv) {};
\node at (0, -\r - 1) (cliv) {};    
\node at (0, -2*\r - 2) (intv) {};  

\draw [rounded corners, dashed] (BAv) rectangle node{\textbf{BA} vector} +(3, -1);
\draw [rounded corners, dashed] (mv) rectangle node{\textbf{mesh} vector} +(3, -1);
\draw [rounded corners, dashed] (cliv) rectangle node{\textbf{climatic} vector : named clim variable} +(6.2, -1);
\draw [rounded corners, dashed] (intv) rectangle node{\textbf{int} vector : log of integration param} +(6.2, -1);

\end{scope}

\begin{scope}[xshift = 0 cm, yshift = -3.6 cm]
\node at (0,0) (fit) {};
\draw [rounded corners, fill = g4!60] (fit) rectangle +(8.6, -3.4);
\node [below right=\r cm and \r cm of fit] {
    \textbf{Fit class} (function params)
};
\node at (\r, -1.2) (sv) {};
\draw [rounded corners, dotted] (sv)rectangle node{\textbf{Survival}} +(2.5, -1);
\node [right= 2.5 cm of sv] (gr) {};
\draw [rounded corners, dotted] (gr) rectangle node{\textbf{Growth}} +(2.2, -1);
\node [right= 2.2 cm of gr] (rec) {};
\draw [rounded corners, dotted] (rec) rectangle node{\textbf{Recruitment}} +(3, -1) ;

\node [below right= 1.2 cm and \r cm of sv] {species name and $max\_dbh$};

\end{scope}

\node at (8.6 + \r, -3*\r - 3) (infv) {};
\draw [rounded corners, dashed] (infv) rectangle node[text width=3cm, align= center]{
    \textbf{info} vector \\~\\ species name, \\ correction, clim\_lab, surv, compress, delay} +(3.6, -3.4);

\end{scope}

\end{scope}

\end{scope}

\begin{scope}[xshift = -6.6 cm, yshift = -1cm]
% Légende
% layout
\node at (0, 0) (class) {};           \node at (3.2, 0) (list) {};
\node at (0, -\r - 1) (vector) {};    \node at (3.2, -\r - 1) (fun) {};

\node[above right= 0cm and 0cm of class] {\textbf{Legend}};
\draw [rounded corners] (class) rectangle node{\textbf{S3 Class} object} +(3, -1);
\draw [rounded corners, dashed] (vector) rectangle node{\textbf{vector} object} +(3, -1);
\draw [rounded corners, dotted] (list) rectangle node{\textbf{list} object} +(3, -1);
\draw [rounded corners, loosely dashdotted] (fun) rectangle node{\textbf{function()}} +(3, -1);

\end{scope}

\end{tikzpicture}
```

---

# Run simulations


```{r sp1sim}
set.seed(42) # The seed is here for initial population random functions.
Picea_sim <- sim_deter_forest(
    Picea_for, 
    tlim = 200, 
    equil_time = 300, equil_dist = 50, equil_diff = 1,
    SurfEch = 0.03,
    verbose = TRUE
)
```

---
exclude: false

```{r timeline_explain1, engine='tikz', fig.ext = 'png', engine.opts = list(template = "tex/tikz.tex"), echo = FALSE, eval=TRUE}
\begin{tikzpicture}

    \draw[ultra thick] (0,3) node[above= 25pt] {\textbf{A}};
    \draw[ultra thick] (0,0) -- (12,0);
    \draw[ultra thick] (0,0) node[below=3pt,thick] {$t_0$};
    \draw[ultra thick] (2,0) node[below=3pt,thick] {$t_1$};
    \draw[ultra thick] (6,0) node[below=3pt, thick] {$t_{lim}$};
    \draw[ultra thick] (12,0) node[below=3pt, thick] {$t_{equil\_time}$};
    \draw[ultra thick] (10,0) node[below=3pt, thick] {$t_{equil}$} {};
    \foreach \x in {0, 2,4,6,8,10, 12}
    \draw (\x cm,3pt) -- (\x cm,-3pt);

    \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (0,3.2)  -- +(6,0) 
       node [black,midway,above=4pt, font=\scriptsize] {Mandatory recorded simulation};
   %  \draw[green, line width=40pt](0,1) -- +(6,0);
    \fill[blue!10] (0,0.5) rectangle ++(6,2.5);
    \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (6,3.2)  -- +(3.9,0) 
         node [black,midway,above=4pt, font=\scriptsize] {Discarded steps};
    \fill[orange!10] (6,0.5) rectangle ++ (3.9,2.5);

      \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (7,1.8)  -- +(3,0) 
         node [black,midway,above=4pt, font=\scriptsize] {equil\_dist};
      \draw[lightgray, line width=10pt](7,1.6) -- +(2.9,0);
      \draw [thick ,decorate,decoration={brace,amplitude=5pt, mirror}] (10,1.4)  -- +(0,0.4) 
      node [black,midway,right=4pt, font=\scriptsize] {equil\_diff};
      \draw[green, line width=10pt](9.9,1.6) -- +(.1,0);

    \begin{axis}[trig format plots=rad,axis lines=left, axis line style={draw=none},
      xtick=\empty,ytick=\empty, width=11.5cm,height=5.5cm,
      xmin=0, xmax=4, ymin=0, ymax=3, ylabel=$BA$, ylabel near ticks
      ]
  \addplot[mark=*,mark size=1pt,color=blue!70!black,samples=200] {1.2+exp(-x)*sin(5*x)};
  \end{axis}
  
  \node[font=\scriptsize, above] at (11.5, 3.2) {Recorded equilibrium};
  \draw[green, ->] plot [smooth, tension=1] coordinates {(10, 1.8) (10.2,2.2) (11.1, 2.7) (11.5, 3.2)};
  
\end{tikzpicture}
```


---
exclude: true

```{r timeline_explain2, engine='tikz', fig.ext = 'png', engine.opts = list(template = "tex/tikz.tex"), echo = FALSE, eval=TRUE}
\begin{tikzpicture}

      \draw[ultra thick] (0,3) node[above= 25pt] {\textbf{B}};
      \draw[ultra thick] (0,0) -- (12,0);
      \draw[ultra thick] (0,0) node[below=3pt,thick] {$t_0$};
      \draw[ultra thick] (2,0) node[below=3pt,thick] {$t_1$};
      \draw[ultra thick] (8,0) node[below=3pt, thick] {$t_{lim}$};
      \draw[ultra thick] (10,0) node[below=3pt, thick] {$t_{equil}$} {};
      \draw[ultra thick] (12,0) node[below=3pt, thick] {$t_{equil\_time}$};
      \foreach \x in {0, 2,4,6,8,10, 12}
      \draw (\x cm,3pt) -- (\x cm,-3pt);
  
      \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (0,3.2)  -- +(8,0) 
         node [black,midway,above=4pt, font=\scriptsize] {Mandatory recorded simulation};
     %  \draw[green, line width=40pt](0,1) -- +(6,0);
      \fill[blue!10] (0,0.5) rectangle ++(8,2.5);
      \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (8,3.2)  -- +(1.9,0) 
         node [black,midway,above=4pt, font=\scriptsize] {Discarded steps};
      \fill[orange!10] (8,0.5) rectangle ++ (1.9,2.5);
  
        \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (7,1.8)  -- +(3,0) 
           node [black,midway,above=4pt, font=\scriptsize] {equil\_dist};
        \draw[lightgray, line width=10pt](7,1.6) -- +(2.9,0);
        \draw [thick ,decorate,decoration={brace,amplitude=5pt, mirror}] (10,1.4)  -- +(0,0.4) 
        node [black,midway,right=4pt, font=\scriptsize] {equil\_diff};
        \draw[green, line width=10pt](9.9,1.6) -- +(.1,0);
  
      \begin{axis}[trig format plots=rad,axis lines=left, axis line style={draw=none},
        xtick=\empty,ytick=\empty, width=11.5cm,height=5.5cm,
        xmin=0, xmax=4, ymin=0, ymax=3, ylabel=$BA$, ylabel near ticks
        ]
    \addplot[mark=*,mark size=1pt,color=blue!70!black,samples=200] {1.2+exp(-x)*sin(5*x)};
    \end{axis}

    \node[font=\scriptsize, above] at (11.5, 3.2) {Recorded equilibrium};
    \draw[green, ->] plot [smooth, tension=1] coordinates {(10, 1.8) (10.2,2.2) (11.1, 2.7) (11.5, 3.2)};
    

     
\end{tikzpicture}
```

---

# Results

Format de sortie de type long prévu pour les plots avec `{ggplot2}` et des filtres `{dplyr}`

```{r sp1head}
Picea_sim  %>%
    dplyr::filter(var == "BAsp", ! equil) %>% head()
```

---

# Plots

```{r sp1plot, out.height= '400px'}
library(ggplot2)
Picea_sim  %>% dplyr::filter(var == "BAsp", ! equil) %>%
    ggplot(aes(x = time, y = value)) + geom_line(linewidth = .4) + ylab("BA")
```

---

# Loop algorithm

```{r loop, engine='tikz', fig.ext = 'png', engine.opts = list(template = "tex/tikz.tex"), echo = FALSE, eval=TRUE}

\tikzset{
    recp/.pic={
        \draw (0.2, 1) node[circle,minimum size=2cm] (p) {};
        \draw (-0.2,-0.1) node[fill = strange,circle,minimum size=0.5cm] (p1) {};
        \draw node[above right = 0.5cm and 0.1 cm of p1,
         fill = strange,circle,minimum size=0.5cm] (p2) {};
        \draw node[above right = -0.2cm and 0.5 cm of p1,
        fill = strange,circle,minimum size=0.5cm] (p3) {};
    }
}

\tikzset{
        kernel/.pic={
        \foreach \i in {5,4.5,...,0.5}{
            {\fill[gray!50] (\i, 5-\i) -- (5,5-\i) -- (5,5) -- (\i,5);}
        }
        \draw (0,0) grid[step=.5] (5,5);
    }
}

\tikzset{
    kernf/.pic={
        \fill[white] (0, 0) -- (5,0) -- (5,5) -- (0,5) -- cycle;
    }
}

\def\nsp{3}
\begin{tikzpicture}[
    block/.style={draw,fill=strange,minimum height=2.5em},
    ncirc/.style={fill = strange,circle,minimum size=2cm},
    font=\sffamily,>=stealth, 
    scale=0.25, every node/.style={transform shape}, scale line widths]

    % Single species functions
    \begin{scope}[start chain=A going below,node distance=3cm,
    local bounding box=buffers]
    \foreach \X in {1,...,\nsp}
    {

    \ifthenelse{\equal{\X}{1}}{\def\sop{1}}{\def\sop{0.3}}

    \draw node[ncirc, on chain] (nzt-\X) {$n(s_{\getnthelement{\X}},z,t)$};

    \draw node[right= 4cm of nzt-\X, ncirc, opacity = \sop] (ng-\X) {};
    \draw node[right= 3cm of ng-\X, ncirc, opacity = \sop] (nh-\X) {};
    \draw node[right= 3cm of nh-\X, ncirc, opacity = \sop] (nd-\X) {};
    \draw node[right= 3cm of nd-\X, ncirc, draw] (nr-\X) {$n(s_{\getnthelement{\X}},z,t+1)$};

    \draw[->, thick, opacity = \sop](nzt-\X) edge node[midway, above](ngf-\X){Growth $\times$ Mortality} (ng-\X);
    \draw[->, thick, opacity = \sop](ng-\X) edge node[midway, above](nhf-\X){Harvesting} (nh-\X);
    \draw[->, thick, opacity = \sop](nh-\X) edge node[midway, above]{Disturbance} (nd-\X);
    \draw[->, thick, opacity = \sop](nd-\X) edge node[midway, above](rec-\X){Recruitment} (nr-\X);

    \node[below right= 1.5cm and 0.1 cm of rec-\X] (recp-\X) {};
    \draw pic[below= 2.2cm of rec-\X, opacity = \sop] {recp};
    \draw[->, thick, opacity = \sop](p) edge node[midway]{} (nr-\X);
    \draw[->, thick, opacity = \sop](nd-\X) edge node[midway]{} (p);

    \draw node[below= 0.5cm of nh-\X, ncirc, draw] (harv-\X) {$h(s_{\getnthelement{\X}},z,t)$};
    \draw[->, thick, opacity = \sop](nhf-\X) edge node[midway]{} (harv-\X);

    }
    \end{scope} 

    % Common node with BA computation
    \node[right=2cm of buffers,align=center,inner sep=0.5pt,fill=strange,
        circle] (cBA) {$\sum_{i=1}^{nsp} n(s_i, z, t+1)$};
    \draw node[right= 3cm of cBA, ncirc, draw] (BA) {BATOTSP};
    \draw[->, thick](cBA) edge node[midway, fill=white]{Compute BA} (BA);
    % arros from nt+1 to BA
    \foreach \X in {1,...,\nsp} 
    {
        \draw[->,thick] (nr-\X.east) --  ++ (1cm,0) -- (cBA);
    }

    % get sim ipm
    \begin{scope}[start chain=A going below,node distance=3cm,
        local bounding box=buffers]
        \foreach \X in {1,...,\nsp}
        {

        \ifthenelse{\equal{\X}{1}}{\def\sop{1}}{\def\sop{0.3}}
        \draw node[right= 13cm of nr-\X, ncirc, fill = white] (getipm-\X) {};
        \draw pic[below left= 0cm and 0cm of getipm-\X, scale = 0.3, opacity = \sop]  {kernel};
        \draw[<-,thick, opacity = \sop] (getipm-\X.west) -- node[above](s){$get\_sim\_ipm()$} ++(-2.5cm, 0) -- (BA);
        }
    \end{scope} 

    % print ipm list
    \begin{scope}[shift={($(getipm-1.west)+(-5.2cm,-0.5cm)$)}]
        \node at (1, 1.8) {$s_i$ IPMs};
        \draw (0.8,-0.4) pic[scale = 0.3, opacity = 0.2]  {kernel};
        \draw (0.4,-0.2) pic[scale = 0.3] {kernf};
        \draw (0.4,-0.2) pic[opacity = 0.4, scale = 0.3]  {kernel};
        \draw (0,0) pic[scale = 0.3] {kernf};
        \draw (0,0) pic[opacity = 0.6, scale = 0.3]  {kernel};
    \end{scope} 

    % BATOTNON sp arrows
    \draw node[right= 4cm of nr-1, ncirc] (bansp-1) {\scriptsize BATOTNONSP};
    \draw[->,thick] (nr-1) -- (bansp-1);
    \draw[->,thick] (BA) -- (bansp-1);
    \draw[->,thick, loosely dotted] (bansp-1.north) -- ++ (0,1cm) -- ($(rec-1.north)+(0,1.5cm)$) -- (rec-1.north);

    % retroaction arrow of the IPM
    \draw[->,thick, loosely dotted] (getipm-1.north) -- ++ (0,1.5cm) -- ($(ngf-1.north)+(0,2.1cm)$) -- (ngf-1.north);


    \begin{scope}[xshift = -8 cm, yshift = -1cm]
        % Légende
        % layout
        \node at (0, 0) (size) {};          
        \node at (2.3, 0) (out) {}; 
        
        \node at (-1, -2.5) (as) {};  \node at (4, -2.5) (ae) {};
        \node at (-1, -3.5) (ds) {};  \node at (4, -3.5) (de) {}; 
    
        \node[above right= 1cm and -1cm of size] {\textbf{Legend}};
        \draw node[ncirc] at (size) { \scriptsize Size distribution};
        \draw node[ncirc, draw] at (out) { \scriptsize Saved output};
        \draw[->, thick](as) edge node[midway, above, fill=white]{Function} (ae);
        \draw[->, thick, dotted](ds) edge node[midway, fill=white]{Retroaction at $t+1$} (de);
    
    \end{scope}
    

\end{tikzpicture}
```

---

# Multiple species

```{r second_species, include = FALSE, cache = TRUE}
data("fit_Abies_alba")

Abies_ipm <- make_IPM(
    species = "Abies_alba", 
    climate = climate, # this variable is defined at the top of the doc.
    fit = fit_Abies_alba,
    clim_lab = "optimum clim",
    mesh = c(m = 700, L = 90, U = get_maxdbh(fit_Abies_alba) * 1.1),
    BA = 0:120, # Default values are 0:200, smaller values speed up this vignette.
    verbose = TRUE
)
Abies_sp <- species(IPM = Abies_ipm, init_pop = def_initBA(35))
```

```{r nsp_forest}
Picea_Abies_for <- forest(species = list(Picea = Picea_sp, Abies = Abies_sp))
set.seed(42)
Picea_Abies_sim <- sim_deter_forest(
    Picea_Abies_for, 
    tlim = 500, 
    equil_time = 500, equil_dist = 50,
    SurfEch = 0.03
)
```

```{r sp2plot, out.height= '350px', out.width='600px', echo = FALSE}
Picea_Abies_sim  %>%
    dplyr::filter(var == "BAsp", ! equil) %>%
    ggplot(aes(x = time, y = value, color = species)) +
    geom_line(linewidth = .4) + ylab("BA") +
    stat_summary(fun = "sum",  aes(col="Total"),
                 geom ='line', linetype = "dashed", linewidth = .3)
```

---

```{r nsp_timeline, engine='tikz', fig.ext = 'png', engine.opts = list(template = "tex/tikz.tex"), echo = FALSE, eval=TRUE}
\begin{tikzpicture}

   \draw[ultra thick] (0,3) node[above= 25pt] {\textbf{A}};
   \draw[ultra thick] (0,0) -- (12,0);
   \draw[ultra thick] (0,0) node[below=3pt,thick] {$t_0$};
   \draw[ultra thick] (2,0) node[below=3pt,thick] {$t_1$};
   \draw[ultra thick] (6,0) node[below=3pt, thick] {$t_{lim}$};
   \draw[ultra thick] (12,0) node[below=3pt, thick] {$t_{equil\_time}$};
   \draw[ultra thick] (10,0) node[below=3pt, thick] {$t_{equil}$} {};
   \foreach \x in {0, 2,4,6,8,10, 12}
   \draw (\x cm,3pt) -- (\x cm,-3pt);

   \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (0,3.2)  -- +(6,0) 
      node [black,midway,above=4pt, font=\scriptsize] {Mandatory recorded simulation};
  %  \draw[green, line width=40pt](0,1) -- +(6,0);
   \fill[blue!10] (0,0.5) rectangle ++(6,2.5);
   \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (6,3.2)  -- +(3.9,0) 
        node [black,midway,above=4pt, font=\scriptsize] {Discarded steps};
   \fill[orange!10] (6,0.5) rectangle ++ (3.9,2.5);

     \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (7,1.9)  -- +(2.9,0) 
        node [black,midway,above=4pt, font=\scriptsize] {equil\_dist};
     \draw[lightgray, line width=8pt](7,1.7) -- +(2.9,0);
     \draw [thick ,decorate,decoration={brace,amplitude=5pt, mirror}] (9.9,1.5)  -- +(0,0.4) 
     node [black,midway,right=4pt, font=\scriptsize] {equil\_diff};
     \draw[green, line width=12pt](9.9,0.85) -- +(.1,0);

   \begin{axis}[trig format plots=rad,axis lines=left, axis line style={draw=none},
     xtick=\empty,ytick=\empty, width=11.5cm,height=5.5cm,
     xmin=0, xmax=4, ymin=0, ymax=6, ylabel=$BA$, ylabel near ticks
     ]
 \addplot[mark=*,mark size=1pt,color=cyan!70!black,samples=200] {1.4+exp(-x)*sin(10*x)};
 \addplot[mark=*,mark size=1pt,color=teal!70!black,samples=200] {1.2+exp(-x)*sin(2*x)};
 \addplot[mark=*,mark size=1pt,color=gray!70!black,samples=200] {1.4+exp(-x)*sin(10*x)+ 1.2+exp(-x)*sin(2*x)};
 \end{axis}
 
 \node[font=\scriptsize, above] at (11.5, 3.2) {Recorded equilibrium};
 \draw[green, ->] plot [smooth, tension=1] coordinates {(10, 0.95) (10.2,1.2) (11.8, 1.7) (11.5, 3.2)};
 
 \node[font=\scriptsize, right, cyan!70!black] at (10, 0.97) {species A};
 \node[font=\scriptsize, right, teal!70!black] at (10, 0.78) {species B};
 \node[font=\scriptsize, align= center, above, gray!70!black] at (5, 1.8) {Species sum \\(not recorded)};


\end{tikzpicture}
```


---

# Harvesting : Uneven

Pour changer le mode de coupe, il faut faire attention, certain paramêtres sont définis pour les espèces et d'autres pour le niveau peuplement !

* Coupe irrégulière :

```{r, include = FALSE}
Picea_sp$init_pop <- def_initBA(10)
Abies_sp$init_pop <- def_initBA(10)
```

```{r}
Picea_for_Uneven <- forest(species = list(Picea = Picea_sp, Abies = Abies_sp), 
                      harv_rules = c(Pmax = 0.75, dBAmin = 3, 
                                     freq = 5, alpha = 1))
set.seed(42)
Picea_Abies_sim_uneven <- sim_deter_forest(
    Picea_for_Uneven,  
    tlim = 100, 
    equil_time = 100, equil_dist = 50,
    SurfEch = 0.03, 
    verbose = TRUE
)

Picea_Abies_sim_uneven  %>%
    dplyr::filter(var == "BAsp", ! equil) %>%
    ggplot(aes(x = time, y = value, color = species)) +
    geom_line(linewidth = .4) + ylab("BA") +
    stat_summary(fun = "sum",  aes(col="Total"),
                 geom ='line', linetype = "dashed", linewidth = .3)
```



---

class: inverse, center, middle

# Merci! Des questions &#x2753;

<!-- Slides en ligne [https://gowachin.github.io/R_presentation/CSU_RepRo.html](https://tinyurl.com/ycktp4kv) -->

<!-- [Fichiers source `r icons::fontawesome("r-project")`](https://github.com/gowachin/R_presentation) &nbsp;&nbsp;|&nbsp;&nbsp; [Fichier pdf `r icons::fontawesome("file-pdf")`](https://github.com/gowachin/R_presentation/raw/main/CSU_RepRo.pdf) -->

`r icons::fontawesome("github")` [gowachin](https://github.com/gowachin) &nbsp;&nbsp;&nbsp;&nbsp; `r icons::fontawesome("stack-overflow")` [gowachin](https://stackoverflow.com/users/12501379/gowachin)

.footnote[
Slides created via the R package [**xaringan**](https://github.com/yihui/xaringan).
]
