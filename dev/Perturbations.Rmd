---
title: "Perturbations"
author: "Maxime Jaunatre"
date: "2022-12-08"
output: pdf_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Testing simulation with perturbations

This document show how to simulate a species with perturbation occuring in time.
For now, the package is in experimental state and use the branch *tempest*. For this example we will use the species *Picea abies* as an example.

```{r constant}
# Libraries
library(ggplot2)
library(dplyr)
library(devtools)

# Loading all functions of the package
devtools::load_all()
species <- "Picea_abies"
data(list = paste0("fit_", species))
fit <- eval(parse(text=paste0("fit_", species)))
climate <- subset(climate_species, sp == species, select = -sp)
```

## Disturbance

### Definition of disturbance

### Impact on population

The disturbance impact on a population result from parameters computed by Julien. They compose a function that takes the size distribution, quadratic diameter of the species, intensity and duration of the disturbance. A set of parameters was made for each type of disturbance and species

$$
dqm = \sqrt{\frac{\sum_{i=1}^m size_i^2 \times value_i}{\sum_{i=1}^m value_i}} \\
logratio = log(\frac{size}{dqm}) \\
dbh.scaled = dbh.intercept + size \times dbh.slope \\
logratio.scaled = logratio.intercept + logratio \times logratio.slope \\
X_{t+1} = X_t \times (1 - plogis(a_0 + a_1 \times logratio.scaled + b \times I^{c \times dbh.scaled}))^t 
$$
$$
X_{t+1} = X_t \times (1 - plogis(a_0 + a_1 \times (logratio.intercept + log(\frac{size}{dqm}) \times logratio.slope) + b \times I^{c \times (dbh.intercept + size \times dbh.slope)}))^t
$$

```{r data_pkg}
disturbance_coef <- treeforce::disturb_coef

filter(disturbance_coef, species == "Fagus_sylvatica")

#' Default disturbance function
#' 
#' @param x population state distribution at time t
#' @param species The species class object of interest to get mesh and RDIcoef
#' values from. RDIcoef is a one line dataframe with RDI coefficient for one
#' species.
#' @param disturb Disturbance parameters. Highly depend on the disturbance 
#' impact parameters given to the species.
#' @param ... Default disturbance function does not require 
#' 
def_disturb_fun <- function(x, species, disturb = NULL, ...){
    
    if(! is.null(disturb)){
        warning(paste0("default disturbance function does not impact populations",
                       ". Please add your own disturbance function."))
    }
    Pkill <- numeric(lenght(x))
    
    return(x* Pkill)
}

```


## Simulations

We need to remove survival during perturbation. This is done during simulation at the step where we get the IPM matrix with get_step_IPM.

```{r, eval = FALSE}
# TODO  find a way to show this !
```



```{r compare_IPM}
step_climate <- subset(climate, N ==2, select = -N)
step_climate <- drop(as.matrix(step_climate))
time <- 2500
ipm_Picea <- make_IPM(
    "Picea_abies", step_climate, "opt_Picab_clim", fit = fit_Picea_abies,
    mesh = c(m = 700, L = 90, U = get_maxdbh(fit_Picea_abies) * 1.1),
    BA = 0:100, verbose = TRUE
)
Picea_abies <- species(IPM = ipm_Picea, init_pop = def_initBA(40),
                           harvest_fun = def_harv)
forest_ipm <- new_forest(species = list(Picea = Picea_abies))
set.seed(42)
memor <- sim_deter_forest.forest(forest_ipm, tlim = time,
                                     equil_dist = time, equil_time = time,
                                     verbose = TRUE, correction = "cut") %>%
    tree_format()

memor %>%
    filter(var %in% c("BAsp", "H", "N"), ! equil, value != 0) %>%
    ggplot(aes(x = time, y = value)) +
    facet_wrap(~ var, scales = "free_y") +
    geom_line(size = .4) + geom_point(size = .4) +
    NULL
```

## Targets

* Multiple species simulations


