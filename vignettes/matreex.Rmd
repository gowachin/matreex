---
title: "Basic functions and examples"
package: matreex
output: 
    github_document:
    rmarkdown::html_vignette:
vignette: >
  %\VignetteIndexEntry{Basic functions and examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: references.bib 
link-citations: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(cli.progress_show_after = 600) 
# 10 minutes before showing a cli progress bar
```

This vignette illustrates the basic pipeline used to run simulations with `{matreex}` package. The user can define different species of interest to combine and use in a simulation. During those simulations, modules can be triggered to test hypothesis and scenarii.

# Simulations input

## Define a species

Before simulating forest, we need first to define tree species in R. Species regroups basic dynamic functions : growth, recruitment and survival. To speed up computation, this package rely on **integrated projection models** (later named IPM). To explain this principle quickly, it is a matter of discretizing the dynamic functions into a kernel that allows us to go from a size distribution at time t to the distribution at time t+1. 

To build this IPM for a species, we start from the fitted functions. Theses functions depend on the size variable and climatic variables. The data provided with the package comes from @kunstler2021, and climatic variable are *sgdd* and *wai*.

```{r hide library, echo = FALSE}
# I do this before to show data inline
library(matreex)
data("fit_Picea_abies")
```

An IPM is mostly defined by it's mesh dimension, that are here $700 \times 700$ between 90mm and `get_maxdbh(fit_Picea_abies) * 1.1` = `r get_maxdbh(fit_Picea_abies) * 1.1`mm. This method is the same as in @kunstler2021 and is used to limit eviction during simulations.

**Please keep in mind this computation is intensive and may take few minutes !**

```{r make_IPM_Picea}
library(matreex)
library(dplyr)
library(ggplot2)

# Load fitted model for a species
# fit_species # list of all species in dataset
data("fit_Picea_abies")

# Load associated climate
data("climate_species")
climate <- subset(climate_species, N == 2 & sp == "Picea_abies", select = -sp)
# N here is a climate defined in Kunstler et al 2021. 
# N == 2 is the optimum climate for the species. 
# see ?climate_species for more info.
climate

Picea_ipm <- make_IPM(
    species = "Picea_abies", 
    climate = climate, 
    fit = fit_Picea_abies,
    clim_lab = "optimum clim", 
    mesh = c(m = 700, L = 90, U = get_maxdbh(fit_Picea_abies) * 1.1),
    BA = 0:60, # Default values are 0:200, smaller values speed up this vignette.
    verbose = TRUE
)
```

Once the IPM is integrated on a BA range, we can use it to build a species upon it. In R, a species is a list object that is constructed with the `species()` function. This list require few more functions to work during simulations :

* `init_pop` : Function to draw the initial size distribution. The default one draw distribution for a basal area (later named BA) of 1 with random functions. The package provide other function to draw random distribution at a selected BA (`def_initBA()`) or a given distribution (`def_init_k()`).

* `harvest_fun` : Function that cut tree given the size distribution. The default function cut 0.6% of the trees regardless of their size at constant rate. Further functions allow to harvest according to Uneven and Even rules.

* `disturb_fun` : Function that return tree mortality after a disturbance. The default one does not react to disturbance.

A species also comes with few parameters, but they are only used for harvest and disturbance modules.

For this example, we will just modify the initial size distribution to start at a reasonable basal area.

```{r species}
Picea_sp <- species(IPM = Picea_ipm, init_pop = def_initBA(30))
```

## Define a forest

Once each species is set, we can assemble them in a `forest` object. This scale also require to give additional parameters, but they are only used for harvest and disturbance modules.

```{r forest}
Picea_for <- forest(species = list(Picea = Picea_sp))
```

# Running simulations

Simulations will run until a given time limit is reached and can continue further if an equilibrium is not reached. Another parameters is the used surface `SurfEch`, and it's define the surface of the studied forest. This parameter is mainly here for historical purpose as models were fitted on $300m^2$ plot, and output is scaled to an hectare.

```{r sp1sim}
set.seed(42) # The seed is here for initial population random functions.
Picea_sim <- sim_deter_forest(
    Picea_for, 
    tlim = 200, 
    equil_time = 300, equil_dist = 50, equil_diff = 1,
    SurfEch = 0.03,
    verbose = TRUE
)
```

To explain the time limit, above we simulate for 200 (`tlim`) years and past this time we continue the simulation (see figure A). This simulation will continue until the 300th year (`equil_time`) unless it reach an equilibrium. An equilibrium (in green) is defined as a step for which the `equil_dist` last steps (in grey) have a BA range below `equil_diff`. The steps between `tlim` and `t_equil` are not recorded.

If `t_equil` is higher than `tlim`, the algorithm will calculate at each time step starting at `tlim` the range of basal area over the last `equil_dist` steps (see figure B). This is why `equil_dist` must not be higher than `tlim`. The equilibrium is reached at the first timestep for which the basal area range is lower than `equil_diff`.

If we want to register the full dynamic, we can set `tlim = equil_time` (see figure C). **The equilibrium is always the last size distribution** (shown in green in figure). In this case, the final distribution will be returned in result twice. The `equil_dist` and `equil_diff` parameters are not important in this case.

```{r timeline_explain, engine='tikz', fig.ext = 'png', engine.opts = list(template = "tex/tikz.tex"), echo = FALSE, eval=TRUE}
\begin{tikzpicture}

    \draw[ultra thick] (0,3) node[above= 25pt] {\textbf{A}};
    \draw[ultra thick] (0,0) -- (12,0);
    \draw[ultra thick] (0,0) node[below=3pt,thick] {$t_0$};
    \draw[ultra thick] (2,0) node[below=3pt,thick] {$t_1$};
    \draw[ultra thick] (6,0) node[below=3pt, thick] {$t_{lim}$};
    \draw[ultra thick] (12,0) node[below=3pt, thick] {$t_{equil\_time}$};
    \draw[ultra thick] (10,0) node[below=3pt, thick] {$t_{equil}$} {};
    \foreach \x in {0, 2,4,6,8,10, 12}
    \draw (\x cm,3pt) -- (\x cm,-3pt);

    \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (0,3.2)  -- +(6,0) 
       node [black,midway,above=4pt, font=\scriptsize] {Mandatory recorded simulation};
   %  \draw[green, line width=40pt](0,1) -- +(6,0);
    \fill[blue!10] (0,0.5) rectangle ++(6,2.5);
    \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (6,3.2)  -- +(3.9,0) 
         node [black,midway,above=4pt, font=\scriptsize] {Discarded steps};
    \fill[orange!10] (6,0.5) rectangle ++ (3.9,2.5);

      \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (7,1.8)  -- +(3,0) 
         node [black,midway,above=4pt, font=\scriptsize] {equil\_dist};
      \draw[lightgray, line width=10pt](7,1.6) -- +(2.9,0);
      \draw [thick ,decorate,decoration={brace,amplitude=5pt, mirror}] (10,1.4)  -- +(0,0.4) 
      node [black,midway,right=4pt, font=\scriptsize] {equil\_diff};
      \draw[green, line width=10pt](9.9,1.6) -- +(.1,0);

    \begin{axis}[trig format plots=rad,axis lines=left, axis line style={draw=none},
      xtick=\empty,ytick=\empty, width=11.5cm,height=5.5cm,
      xmin=0, xmax=4, ymin=0, ymax=3, ylabel=$BA$, ylabel near ticks
      ]
  \addplot[mark=*,mark size=1pt,color=blue!70!black,samples=200] {1.2+exp(-x)*sin(5*x)};
  \end{axis}
  
  \node[font=\scriptsize, above] at (11.5, 3.2) {Recorded equilibrium};
  \draw[green, ->] plot [smooth, tension=1] coordinates {(10, 1.8) (10.2,2.2) (11.1, 2.7) (11.5, 3.2)};
  

   \begin{scope}[yshift=-5.5cm]

      \draw[ultra thick] (0,3) node[above= 25pt] {\textbf{B}};
      \draw[ultra thick] (0,0) -- (12,0);
      \draw[ultra thick] (0,0) node[below=3pt,thick] {$t_0$};
      \draw[ultra thick] (2,0) node[below=3pt,thick] {$t_1$};
      \draw[ultra thick] (8,0) node[below=3pt, thick] {$t_{lim}$};
      \draw[ultra thick] (10,0) node[below=3pt, thick] {$t_{equil}$} {};
      \draw[ultra thick] (12,0) node[below=3pt, thick] {$t_{equil\_time}$};
      \foreach \x in {0, 2,4,6,8,10, 12}
      \draw (\x cm,3pt) -- (\x cm,-3pt);
  
      \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (0,3.2)  -- +(8,0) 
         node [black,midway,above=4pt, font=\scriptsize] {Mandatory recorded simulation};
     %  \draw[green, line width=40pt](0,1) -- +(6,0);
      \fill[blue!10] (0,0.5) rectangle ++(8,2.5);
      \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (8,3.2)  -- +(1.9,0) 
         node [black,midway,above=4pt, font=\scriptsize] {Discarded steps};
      \fill[orange!10] (8,0.5) rectangle ++ (1.9,2.5);
  
        \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (7,1.8)  -- +(3,0) 
           node [black,midway,above=4pt, font=\scriptsize] {equil\_dist};
        \draw[lightgray, line width=10pt](7,1.6) -- +(2.9,0);
        \draw [thick ,decorate,decoration={brace,amplitude=5pt, mirror}] (10,1.4)  -- +(0,0.4) 
        node [black,midway,right=4pt, font=\scriptsize] {equil\_diff};
        \draw[green, line width=10pt](9.9,1.6) -- +(.1,0);
  
      \begin{axis}[trig format plots=rad,axis lines=left, axis line style={draw=none},
        xtick=\empty,ytick=\empty, width=11.5cm,height=5.5cm,
        xmin=0, xmax=4, ymin=0, ymax=3, ylabel=$BA$, ylabel near ticks
        ]
    \addplot[mark=*,mark size=1pt,color=blue!70!black,samples=200] {1.2+exp(-x)*sin(5*x)};
    \end{axis}

    \node[font=\scriptsize, above] at (11.5, 3.2) {Recorded equilibrium};
    \draw[green, ->] plot [smooth, tension=1] coordinates {(10, 1.8) (10.2,2.2) (11.1, 2.7) (11.5, 3.2)};
    

     \end{scope}

     \begin{scope}[yshift=-11cm]

      \draw[ultra thick] (0,3) node[above= 25pt] {\textbf{C}};
      \draw[ultra thick] (0,0) -- (12,0);
      \draw[ultra thick] (0,0) node[below=3pt,thick] {$t_0$};
      \draw[ultra thick] (2,0) node[below=3pt,thick] {$t_1$};
      \draw[ultra thick] (12,0) node[below=3pt, thick] {$t_{lim}$};
      \draw[ultra thick] (12,0) node[below=16pt, thick] {$t_{equil\_time}$};
      \foreach \x in {0, 2,4,6,8,10, 12}
      \draw (\x cm,3pt) -- (\x cm,-3pt);
   
      \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (0,3.2)  -- +(12,0) 
      node [black,midway,above=4pt, font=\scriptsize] {Mandatory recorded simulation (include equilibrium)};
   \fill[blue!10] (0,0.5) rectangle ++(12,2.5);
   \draw [gray, thick ,decorate,decoration={brace,amplitude=5pt, mirror}] (12,1.4)  -- +(0,0.4) 
   node [gray,midway,right=4pt, font=\scriptsize] {equil\_diff};


   \draw[green, line width=10pt](11.9,1.6) -- +(.1,0);

   \begin{axis}[trig format plots=rad,axis lines=left, axis line style={draw=none},
     xtick=\empty,ytick=\empty, width=13.5cm,height=5.5cm,
     xmin=0, xmax=5, ymin=0, ymax=3, ylabel=$BA$, ylabel near ticks
     ]
      \addplot[mark=*,mark size=1pt,color=blue!70!black,samples=200] {1.2+exp(-x)*sin(5*x)};
   \end{axis}

        \begin{scope}
         \clip(9.5, 3) rectangle (12, 0);
         \draw [gray, decorate,decoration={brace,amplitude=12pt}] (9,1.8) -- +(3,0)
            node [gray,midway,above=8pt, font=\scriptsize] {equil\_dist};
      \end{scope}
      \draw[gray, dotted] ([yshift=6pt]9, 1.8) -- ([yshift=6pt]9.5,1.8);

      \node[font=\scriptsize, above] at (13.5, 3.2) {Recorded equilibrium};
      \draw[green, ->] plot [smooth, tension=1] coordinates {(12, 1.1) (12.2,1.8) (13.1, 2.5) (13.5, 3.2)};
      
     \end{scope}

\end{tikzpicture}
```

Keep in mind that despite high `tlim` and `equil_time` values, the equilibrium may not be reached at the end of the simulation. There is currently no way in the algorithm to report this to the user. The best way to detect "false equilibrium" is when the last step takes place at `t == equil_time` and by plotting the basal area along time. These cases are illustrated in figure D and E.

Also, this equilibrium is only computed on total basal area, and the distribution can change. We welcome any suggestions you may have regarding the equilibrium definition.

```{r timeline_explain_no_eq, engine='tikz', fig.ext = 'png', engine.opts = list(template = "tex/tikz.tex"), echo = FALSE, eval=TRUE}
\begin{tikzpicture}

    \begin{scope}

      \draw[ultra thick] (0,3) node[above= 25pt] {\textbf{D}};
      \draw[ultra thick] (0,0) -- (12,0);
      \draw[ultra thick] (0,0) node[below=3pt,thick] {$t_0$};
      \draw[ultra thick] (2,0) node[below=3pt,thick] {$t_1$};
      \draw[ultra thick] (12,0) node[below=3pt, thick] {$t_{lim}$};
      \draw[ultra thick] (12,0) node[below=16pt, thick] {$t_{equil\_time}$};
      \foreach \x in {0, 2,4,6,8,10, 12}
      \draw (\x cm,3pt) -- (\x cm,-3pt);
   
      \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (0,3.2)  -- +(12,0) 
      node [black,midway,above=4pt, font=\scriptsize] {Mandatory recorded simulation (include "equilibrium")};
   \fill[blue!10] (0,0.5) rectangle ++(12,2.5);
   \draw[green, line width=10pt](11.9,1.1) -- +(.1,0);

   \begin{axis}[trig format plots=rad,axis lines=left, axis line style={draw=none},
     xtick=\empty,ytick=\empty, width=13.5cm,height=5.5cm,
     xmin=0, xmax=5, ymin=0, ymax=5, ylabel=$BA$, ylabel near ticks
     ]
      \addplot[mark=*,mark size=1pt,color=blue!70!black,samples=200] {2+sin(2*x)};
   \end{axis}

   \node[font=\scriptsize, above] at (13.5, 3.2) {Recorded "equilibrium"};
   \draw[green, ->] plot [smooth, tension=1] coordinates {(12, 1.1) (12.2,1.8) (13.1, 2.5) (13.5, 3.2)};
      
     \end{scope}

     \begin{scope}[yshift=-5.5cm]

      \draw[ultra thick] (0,3) node[above= 25pt] {\textbf{E}};
      \draw[ultra thick] (0,0) -- (12,0);
      \draw[ultra thick] (0,0) node[below=3pt,thick] {$t_0$};
      \draw[ultra thick] (2,0) node[below=3pt,thick] {$t_1$};
      \draw[ultra thick] (12,0) node[below=3pt, thick] {$t_{lim}$};
      \draw[ultra thick] (12,0) node[below=16pt, thick] {$t_{equil\_time}$};
      \foreach \x in {0, 2,4,6,8,10, 12}
      \draw (\x cm,3pt) -- (\x cm,-3pt);
   
      \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (0,3.2)  -- +(6,0) 
      node [black,midway,above=4pt, font=\scriptsize] {Mandatory recorded simulation };
   \fill[blue!10] (0,0.5) rectangle ++(6,2.5);
   \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (6,3.2)  -- +(5.9,0) 
     node [black,midway,above=4pt, font=\scriptsize] {Discarded steps};
   \fill[orange!10] (6,0.5) rectangle ++ (5.9,2.5);

   \draw[lightgray, line width=10pt](9,1.1) -- +(2.9,0);
   \draw[green, line width=10pt](11.9,1.1) -- +(.1,0);

     \begin{axis}[trig format plots=rad,axis lines=left, axis line style={draw=none},
      xtick=\empty,ytick=\empty, width=13.5cm,height=5.5cm,
      xmin=0, xmax=5, ymin=0, ymax=5, ylabel=$BA$, ylabel near ticks
      ]
       \addplot[mark=*,mark size=1pt,color=blue!70!black,samples=200] {2+sin(2*x)};
    \end{axis}

    \node[font=\scriptsize, above] at (13.5, 3.2) {Recorded "equilibrium"};
    \draw[green, ->] plot [smooth, tension=1] coordinates {(12, 1.1) (12.2,1.8) (13.1, 2.5) (13.5, 3.2)};
            
     \end{scope}

\end{tikzpicture}
```

The output of a simulation is a data.frame in long format (according to tidyverse style). This is very helpful to filter the output and plot it with `{ggplot2}`. Variables exported are the basal area per species `BAsp`, the number of individual per mesh for presence `m` and for harvest `h`, the total number of individual for presence `N` and for harvest `H`.

```{r sp1plot}
Picea_sim  %>%
    dplyr::filter(var == "BAsp", ! equil) %>%
    ggplot(aes(x = time, y = value)) +
    geom_line(linewidth = .4) + ylab("BA")
```

If size distributions needs to be extracted, it can be easily done with `{dplyr}` functions. The equilibrium step is associated with a logical to extract it.

```{r sp1head}
head(Picea_sim)

# get the maximum time
max_t <- max(Picea_sim$time)

# Filter example to extract the size distribution
Picea_sim %>% 
    dplyr::filter(grepl("m", var), time == max_t) %>% 
    dplyr::select(size, value)
```

# Customizing the simulations

The above simulation is one of the simplest we can produce with this package. This chapter will describe some basic customization we can add before running a simulation. 

## Initialisation step

By default, the initialization of the population run random process to draw a size distribution for each species. We already show a function (`def_initBA()`) that scale this distribution to a given basal area. However, for a basal area value, multiple distribution are possible. To control the exact distribution at start, we use `def_init_k()`. This choice of starting distribution can be used to reproduce simulations, starting from an equilibrium or a post disturbance state.

Here is an example where we start from $t = 150$ of the previous simulation. This will illustrate that despite the simulation said it reached equilibrium at time $t = 244$, our parameters have introduced a bias. The previous equilibrium is highlighted in blue rectangle.

```{r sp1initk}
distrib_t150 <- Picea_sim %>% 
    dplyr::filter(grepl("m", var), time == 150) %>%
    dplyr::pull(value)
# NOTE : this distribution is given per ha and we need it for SurfEch = 0.03.
distrib_t150 <- distrib_t150 * 0.03

Picea_sp$init_pop <- def_init_k(distrib_t150)

Picea_sim_k <- sim_deter_forest(
    forest(species = list(Picea = Picea_sp)), 
    tlim = 200, 
    equil_time = 300, equil_dist = 50,
    SurfEch = 0.03,
    verbose = TRUE
)

Picea_sim_k  %>%
    dplyr::filter(var == "BAsp", ! equil) %>%
    # below, we keep the time reference of the previous simulation 
    # to simplify the understanding of the full document.
    dplyr::mutate(time = time + 150) %>% 
    ggplot(aes(x = time, y = value)) +
    geom_line(linewidth = .4) + ylab("BA") +
    geom_rect(mapping = aes(xmin = 194, xmax = 244, 
                                     ymin = max(value-1), ymax = max(value)),
                       alpha = 0.002, fill = "blue") +
    geom_text(aes(label = "False equilibrium", x = 219, y = 44.5), size = 4) 
```


## Recruitment delay

We can modify a species to add more delay for recruitment of new individuals. By default, the recruitment is a given number of new individual. This number is split in half and adds to the first two class of size distribution. Adding delay expand the mesh on the lower size side, where the recruitment will be added. The new recruit will age from one class to another until they enter the "real" IPM.

```{r, Forest_delay}
n_delay <- 5
Picea_sp_d5 <- delay(Picea_sp, n_delay)
Picea_sp_d5$info["species"] <- "Picea_delayed" # We rename the species for easier plot.
Picea_sp_d5$init_pop <- def_initBA(30)
```

Simulation doesn't change anything, the delay is only defined at the IPM level.

```{r, delay_sim}
set.seed(42)
Picea_sim_d5 <- sim_deter_forest(
    forest(species = list(Picea = Picea_sp_d5)),
    tlim = 200, 
    equil_time = 200, equil_dist = 50,
    SurfEch = 0.03,
    verbose = TRUE
)
```

Equilibrium BA should be really close ($\Delta_{BA} < 1$). N is expected to increase with delay since delayed mesh cell with seeds are counted in.

```{r, delay_plot}
Picea_sim_d5 %>%
    rbind(Picea_sim) %>%
    dplyr::filter(var %in% c("BAsp", "N"), !equil) %>%
    ggplot(aes(x = time, y = value, color = species)) +
    geom_line(linetype = "dashed", linewidth = .3) +
    geom_point(size = .7) + ylab("BA") +
    facet_wrap(~ var, scales = "free_y") +
    NULL
```

<!-- Despite a really close BA, the size distribution is different at equilibrium. -->

<!-- *Note : Values below the redline does not count in BA computation.* -->

```{r, delay_dist_plot, eval = FALSE, echo = FALSE}
Picea_sim_d5 %>%
    dplyr::mutate(mesh = mesh - n_delay) %>%
    rbind(Picea_sim) %>%
    dplyr::filter(var == "m", time == 200) %>%
    ggplot(aes(x = mesh, y = value, fill = species, group = desc(species))) +
    geom_area(color = "black", alpha = .3, size = .4, position = "identity") +
    geom_vline(xintercept = 1, color = "red") +
    annotate("text", x = 0, y = .1, label = "Minimal mesh in BA", size = 3,
             color = "red", angle = 90) +
    NULL
```


## Multiple species

Multi-specific simulations are performed like the simulations previously illustrated. The only difference is in the construction of the forest object. This explain why the `species` argument for `forest()` function require a list for input. 

We need to modelise a second species. Be careful to select the same climate as the first species.

```{r second_species}
data("fit_Abies_alba")

Abies_ipm <- make_IPM(
    species = "Abies_alba", 
    climate = climate, # this variable is defined at the top of the doc.
    fit = fit_Abies_alba,
    clim_lab = "optimum clim",
    mesh = c(m = 700, L = 90, U = get_maxdbh(fit_Abies_alba) * 1.1),
    BA = 0:60, # Default values are 0:200, smaller values speed up this vignette.
    verbose = TRUE
)
Abies_sp <- species(IPM = Abies_ipm, init_pop = def_initBA(35))
```

```{r nsp_forest}
# We edit back the init_fun for Picea
Picea_sp$init_pop <- def_initBA(15)
Picea_Abies_for <- forest(species = list(Picea = Picea_sp, Abies = Abies_sp))

set.seed(42)
Picea_Abies_sim <- sim_deter_forest(
    Picea_Abies_for, 
    tlim = 500, 
    equil_time = 500, equil_dist = 50,
    SurfEch = 0.03,
    verbose = TRUE
)

Picea_Abies_sim  %>%
    dplyr::filter(var == "BAsp", ! equil) %>%
    ggplot(aes(x = time, y = value, color = species)) +
    geom_line(linewidth = .4) + ylab("BA") +
    stat_summary(fun = "sum",  aes(col="Total"),
                 geom ='line', linetype = "dashed", size = .3)
```

An important point to note for multiple species is that the equilibrium is defined at the forest level, that is the sum of species basal area.

```{r nsp_timeline, engine='tikz', fig.ext = 'png', engine.opts = list(template = "tex/tikz.tex"), echo = FALSE, eval=TRUE}
\begin{tikzpicture}

   \draw[ultra thick] (0,3) node[above= 25pt] {\textbf{A}};
   \draw[ultra thick] (0,0) -- (12,0);
   \draw[ultra thick] (0,0) node[below=3pt,thick] {$t_0$};
   \draw[ultra thick] (2,0) node[below=3pt,thick] {$t_1$};
   \draw[ultra thick] (6,0) node[below=3pt, thick] {$t_{lim}$};
   \draw[ultra thick] (12,0) node[below=3pt, thick] {$t_{equil\_time}$};
   \draw[ultra thick] (10,0) node[below=3pt, thick] {$t_{equil}$} {};
   \foreach \x in {0, 2,4,6,8,10, 12}
   \draw (\x cm,3pt) -- (\x cm,-3pt);

   \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (0,3.2)  -- +(6,0) 
      node [black,midway,above=4pt, font=\scriptsize] {Mandatory recorded simulation};
  %  \draw[green, line width=40pt](0,1) -- +(6,0);
   \fill[blue!10] (0,0.5) rectangle ++(6,2.5);
   \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (6,3.2)  -- +(3.9,0) 
        node [black,midway,above=4pt, font=\scriptsize] {Discarded steps};
   \fill[orange!10] (6,0.5) rectangle ++ (3.9,2.5);

     \draw [thick ,decorate,decoration={brace,amplitude=5pt}] (7,1.9)  -- +(2.9,0) 
        node [black,midway,above=4pt, font=\scriptsize] {equil\_dist};
     \draw[lightgray, line width=8pt](7,1.7) -- +(2.9,0);
     \draw [thick ,decorate,decoration={brace,amplitude=5pt, mirror}] (9.9,1.5)  -- +(0,0.4) 
     node [black,midway,right=4pt, font=\scriptsize] {equil\_diff};
     \draw[green, line width=12pt](9.9,0.85) -- +(.1,0);

   \begin{axis}[trig format plots=rad,axis lines=left, axis line style={draw=none},
     xtick=\empty,ytick=\empty, width=11.5cm,height=5.5cm,
     xmin=0, xmax=4, ymin=0, ymax=6, ylabel=$BA$, ylabel near ticks
     ]
 \addplot[mark=*,mark size=1pt,color=cyan!70!black,samples=200] {1.4+exp(-x)*sin(10*x)};
 \addplot[mark=*,mark size=1pt,color=teal!70!black,samples=200] {1.2+exp(-x)*sin(2*x)};
 \addplot[mark=*,mark size=1pt,color=gray!70!black,samples=200] {1.4+exp(-x)*sin(10*x)+ 1.2+exp(-x)*sin(2*x)};
 \end{axis}
 
 \node[font=\scriptsize, above] at (11.5, 3.2) {Recorded equilibrium};
 \draw[green, ->] plot [smooth, tension=1] coordinates {(10, 0.95) (10.2,1.2) (11.8, 1.7) (11.5, 3.2)};
 
 \node[font=\scriptsize, right, cyan!70!black] at (10, 0.97) {species A};
 \node[font=\scriptsize, right, teal!70!black] at (10, 0.78) {species B};
 \node[font=\scriptsize, align= center, above, gray!70!black] at (5, 1.8) {Species sum \\(not recorded)};


\end{tikzpicture}
```

# References

<div id="refs"></div>
